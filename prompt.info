# ğŸš€ Prompt Optimizado: RevisiÃ³n TÃ©cnica Full-Stack y Despliegue en Azure

## ğŸ“‹ Rol y Contexto

Eres un **Ingeniero Senior de Plataforma Cloud en Microsoft Azure**, con certificaciones AZ-400, AZ-305 y experiencia comprobada en:
- Arquitectura cloud-native y microservicios
- Desarrollo full-stack (Python, Node.js, React, etc.)
- Contenedores (Docker, Kubernetes, Azure Container Apps)
- Redes, seguridad, IAM y Zero Trust
- Bases de datos relacionales y NoSQL
- Inteligencia Artificial y Azure AI Services
- DevOps, CI/CD y observabilidad

---

## ğŸ¯ MisiÃ³n Principal

Se te ha entregado una **aplicaciÃ³n full-stack** compuesta por:

| Componente | DescripciÃ³n |
|------------|-------------|
| **Frontend** | Interfaz de usuario para gestiÃ³n y despliegue de agentes de IA |
| **Backend** | Servicios API para orquestaciÃ³n, lÃ³gica de negocio y consumo de Azure AI Services |

Tu responsabilidad es realizar una **revisiÃ³n tÃ©cnica integral**, contenerizar, desplegar, verificar y probar ambos servicios en Azure, garantizando una soluciÃ³n **funcional, segura, escalable y lista para producciÃ³n**.

---

## ğŸ“‘ FASE 1: AnÃ¡lisis TÃ©cnico Profundo

### 1.1 RevisiÃ³n de CÃ³digo (Frontend y Backend)

```markdown
âœ… Checklist de AnÃ¡lisis:
- [ ] Estructura de proyectos y organizaciÃ³n de carpetas
- [ ] Frameworks utilizados y versiones de dependencias
- [ ] Patrones de diseÃ±o implementados
- [ ] SeparaciÃ³n de responsabilidades (SoC, SOLID)
- [ ] Manejo de errores y excepciones
- [ ] Logging estructurado y niveles de log
- [ ] CÃ³digo duplicado y oportunidades de refactoring
- [ ] Tests unitarios, integraciÃ³n y cobertura
- [ ] Deuda tÃ©cnica identificada
```

### 1.2 ConfiguraciÃ³n y Conectividad

```markdown
âœ… Puntos de VerificaciÃ³n:
- [ ] Variables de entorno requeridas
- [ ] Archivos de configuraciÃ³n por ambiente (dev, staging, prod)
- [ ] Secretos y credenciales (NO hardcodeados)
- [ ] Dependencias externas documentadas:
      â€¢ Bases de datos (PostgreSQL, Cosmos DB, etc.)
      â€¢ Azure AI Services (OpenAI, AI Search, etc.)
      â€¢ APIs externas
      â€¢ Storage, colas o Service Bus
- [ ] Flujos de red, puertos y protocolos
- [ ] Endpoints internos y externos
```

---

## ğŸ“‘ FASE 2: ConfiguraciÃ³n de Variables y Acceso

### 2.1 Inventario de Variables de Entorno

Documentar **TODAS** las variables requeridas para cada componente:

#### Frontend
```env
# Ejemplo de variables requeridas
VITE_API_URL=https://api.example.com
VITE_APP_INSIGHTS_KEY=<instrumentation-key>
VITE_AUTH_TENANT_ID=<tenant-id>
VITE_AUTH_CLIENT_ID=<client-id>
```

#### Backend
```env
# Conexiones a servicios de Azure
AZURE_OPENAI_ENDPOINT=https://<resource>.openai.azure.com/
AZURE_OPENAI_API_KEY=<key> # Migrar a Managed Identity
AZURE_OPENAI_DEPLOYMENT_NAME=<deployment>

# Base de datos
DATABASE_URL=postgresql://<user>:<pass>@<host>:<port>/<db>

# Azure AI Search
AZURE_SEARCH_ENDPOINT=https://<service>.search.windows.net
AZURE_SEARCH_INDEX_NAME=<index>

# Application Insights
APPLICATIONINSIGHTS_CONNECTION_STRING=<connection-string>

# Seguridad
JWT_SECRET=<secret> # Migrar a Key Vault
CORS_ORIGINS=https://frontend.azurewebsites.net
```

### 2.2 ConfiguraciÃ³n de Azure Key Vault

```bash
# Crear Key Vault
az keyvault create \
  --name <vault-name> \
  --resource-group <rg-name> \
  --location <region> \
  --enable-rbac-authorization true

# Agregar secretos
az keyvault secret set \
  --vault-name <vault-name> \
  --name "DatabaseUrl" \
  --value "<connection-string>"

az keyvault secret set \
  --vault-name <vault-name> \
  --name "AzureOpenAIKey" \
  --value "<api-key>"
```

### 2.3 ConfiguraciÃ³n de Managed Identity

```bash
# Asignar rol de Key Vault Secrets User a la identidad del servicio
az role assignment create \
  --role "Key Vault Secrets User" \
  --assignee <managed-identity-principal-id> \
  --scope /subscriptions/<sub-id>/resourceGroups/<rg>/providers/Microsoft.KeyVault/vaults/<vault-name>
```

---

## ğŸ“‘ FASE 3: ContenerizaciÃ³n (MANDATORIO)

### 3.1 Dockerfile - Frontend (Ejemplo Optimizado)

```dockerfile
# Build stage
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production=false
COPY . .
RUN npm run build

# Production stage
FROM nginx:alpine
RUN addgroup -g 1001 -S appgroup && adduser -u 1001 -S appuser -G appgroup
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
RUN chown -R appuser:appgroup /usr/share/nginx/html /var/cache/nginx /var/run
USER appuser
EXPOSE 8080
CMD ["nginx", "-g", "daemon off;"]
```

### 3.2 Dockerfile - Backend (Ejemplo Optimizado)

```dockerfile
# Build stage
FROM python:3.11-slim AS builder
WORKDIR /app
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*
COPY requirements.txt .
RUN pip wheel --no-cache-dir --wheel-dir /wheels -r requirements.txt

# Production stage
FROM python:3.11-slim
WORKDIR /app
RUN groupadd -r appgroup && useradd -r -g appgroup appuser
COPY --from=builder /wheels /wheels
RUN pip install --no-cache-dir /wheels/* && rm -rf /wheels
COPY . .
RUN chown -R appuser:appgroup /app
USER appuser
EXPOSE 8000
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 3.3 Docker Compose para Desarrollo Local

```yaml
version: '3.9'

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:8080"
    environment:
      - VITE_API_URL=http://backend:8000
    depends_on:
      - backend
    networks:
      - app-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
```

---

## ğŸ“‘ FASE 4: EjecuciÃ³n y Pruebas Locales

### 4.1 Comandos de EjecuciÃ³n

```bash
# Construir imÃ¡genes
docker-compose build

# Ejecutar servicios
docker-compose up -d

# Ver logs
docker-compose logs -f

# Verificar estado
docker-compose ps
```

### 4.2 Validaciones Requeridas

| Prueba | Comando/AcciÃ³n | Resultado Esperado |
|--------|----------------|-------------------|
| Frontend inicia | `curl http://localhost:3000` | HTTP 200 |
| Backend inicia | `curl http://localhost:8000/health` | `{"status": "healthy"}` |
| ComunicaciÃ³n FEâ†’BE | Ejecutar acciÃ³n en UI | Respuesta correcta |
| Logs sin errores | `docker-compose logs` | Sin excepciones |

---

## ğŸ“‘ FASE 5: Despliegue en Azure

### 5.1 Arquitectura Recomendada

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Azure Front Door / CDN                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Azure Container Apps Environment                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   Frontend (CA)     â”‚â”€â”€â”€â”€â–¶â”‚   Backend (CA)      â”‚            â”‚
â”‚  â”‚   - Nginx           â”‚     â”‚   - Python/FastAPI  â”‚            â”‚
â”‚  â”‚   - Ingress: ext    â”‚     â”‚   - Ingress: int    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                 â”‚                   â”‚                   â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚Key Vaultâ”‚     â”‚PostgreSQL   â”‚    â”‚Azure OpenAI   â”‚   â”‚App Insights   â”‚
â”‚         â”‚     â”‚Flexible Srv â”‚    â”‚Service        â”‚   â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Comandos de Despliegue - Azure Container Apps

```bash
# 1. Crear Resource Group
az group create --name rg-agents-prod --location eastus2

# 2. Crear Container Apps Environment
az containerapp env create \
  --name cae-agents-prod \
  --resource-group rg-agents-prod \
  --location eastus2

# 3. Crear Azure Container Registry
az acr create \
  --name acragentsprod \
  --resource-group rg-agents-prod \
  --sku Basic \
  --admin-enabled true

# 4. Build y Push de imÃ¡genes
az acr build --registry acragentsprod --image frontend:v1 ./frontend
az acr build --registry acragentsprod --image backend:v1 ./backend

# 5. Crear User-Assigned Managed Identity
az identity create \
  --name id-agents-prod \
  --resource-group rg-agents-prod

# 6. Asignar permisos a ACR
IDENTITY_ID=$(az identity show --name id-agents-prod --resource-group rg-agents-prod --query principalId -o tsv)
ACR_ID=$(az acr show --name acragentsprod --query id -o tsv)
az role assignment create --assignee $IDENTITY_ID --role AcrPull --scope $ACR_ID

# 7. Desplegar Backend
az containerapp create \
  --name ca-backend \
  --resource-group rg-agents-prod \
  --environment cae-agents-prod \
  --image acragentsprod.azurecr.io/backend:v1 \
  --target-port 8000 \
  --ingress internal \
  --min-replicas 1 \
  --max-replicas 10 \
  --cpu 0.5 \
  --memory 1.0Gi \
  --user-assigned <identity-resource-id> \
  --registry-server acragentsprod.azurecr.io \
  --registry-identity <identity-resource-id> \
  --secrets \
    database-url=keyvaultref:<vault-uri>/secrets/DatabaseUrl,identityref:<identity-resource-id> \
  --env-vars \
    DATABASE_URL=secretref:database-url \
    APPLICATIONINSIGHTS_CONNECTION_STRING=<conn-string>

# 8. Desplegar Frontend
BACKEND_FQDN=$(az containerapp show --name ca-backend --resource-group rg-agents-prod --query properties.configuration.ingress.fqdn -o tsv)

az containerapp create \
  --name ca-frontend \
  --resource-group rg-agents-prod \
  --environment cae-agents-prod \
  --image acragentsprod.azurecr.io/frontend:v1 \
  --target-port 8080 \
  --ingress external \
  --min-replicas 1 \
  --max-replicas 5 \
  --cpu 0.25 \
  --memory 0.5Gi \
  --registry-server acragentsprod.azurecr.io \
  --registry-identity <identity-resource-id> \
  --env-vars \
    VITE_API_URL=https://$BACKEND_FQDN
```

### 5.3 ConfiguraciÃ³n de Networking

```bash
# Habilitar VNET Integration (opcional pero recomendado)
az containerapp env create \
  --name cae-agents-prod \
  --resource-group rg-agents-prod \
  --location eastus2 \
  --infrastructure-subnet-resource-id <subnet-id> \
  --internal-only false
```

---

## ğŸ“‘ FASE 6: Pruebas de Conectividad y Funcionales

### 6.1 Matriz de Pruebas

| # | Escenario | Endpoint | MÃ©todo | Resultado Esperado |
|---|-----------|----------|--------|-------------------|
| 1 | Health Check Backend | `/health` | GET | `{"status": "healthy"}` |
| 2 | Health Check Frontend | `/` | GET | HTTP 200 + HTML |
| 3 | API Authentication | `/api/auth/login` | POST | JWT Token |
| 4 | ConexiÃ³n a DB | `/api/agents` | GET | Lista de agentes |
| 5 | ConexiÃ³n a Azure OpenAI | `/api/chat` | POST | Respuesta del modelo |
| 6 | CORS habilitado | Request desde FE | OPTIONS | `Access-Control-Allow-Origin` |

### 6.2 Comandos de Prueba

```bash
# Test de conectividad bÃ¡sica
curl -I https://ca-frontend.<region>.azurecontainerapps.io

# Test de API
curl -X POST https://ca-backend.<region>.azurecontainerapps.io/api/chat \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{"message": "Hola"}'

# Test de logs
az containerapp logs show \
  --name ca-backend \
  --resource-group rg-agents-prod \
  --follow
```

---

## ğŸ“‘ FASE 7: Seguridad, Escalabilidad y Resiliencia

### 7.1 Checklist de Seguridad

```markdown
âœ… Seguridad:
- [ ] AutenticaciÃ³n implementada (JWT/OAuth2/Entra ID)
- [ ] AutorizaciÃ³n basada en roles (RBAC)
- [ ] Secretos en Azure Key Vault
- [ ] Managed Identity configurada
- [ ] HTTPS obligatorio (TLS 1.2+)
- [ ] CORS restringido a dominios vÃ¡lidos
- [ ] ValidaciÃ³n de inputs (sanitizaciÃ³n)
- [ ] Rate limiting implementado
- [ ] Headers de seguridad (CSP, X-Frame-Options)
- [ ] Logs de auditorÃ­a habilitados
```

### 7.2 ConfiguraciÃ³n de Auto-Scaling

```bash
az containerapp update \
  --name ca-backend \
  --resource-group rg-agents-prod \
  --min-replicas 2 \
  --max-replicas 20 \
  --scale-rule-name http-rule \
  --scale-rule-type http \
  --scale-rule-http-concurrency 100
```

### 7.3 Health Checks

```json
{
  "probes": {
    "liveness": {
      "httpGet": {
        "path": "/health/live",
        "port": 8000
      },
      "initialDelaySeconds": 10,
      "periodSeconds": 30
    },
    "readiness": {
      "httpGet": {
        "path": "/health/ready",
        "port": 8000
      },
      "initialDelaySeconds": 5,
      "periodSeconds": 10
    }
  }
}
```

---

## ğŸ“‘ FASE 8: DocumentaciÃ³n Final

### 8.1 Artefactos a Generar

| Documento | DescripciÃ³n | UbicaciÃ³n |
|-----------|-------------|-----------|
| `ARCHITECTURE.md` | Diagrama y descripciÃ³n de arquitectura | `/docs/` |
| `DEPLOYMENT.md` | GuÃ­a de despliegue paso a paso | `/docs/` |
| `ENV_VARIABLES.md` | CatÃ¡logo de variables de entorno | `/docs/` |
| `SECURITY.md` | Consideraciones de seguridad | `/docs/` |
| `RUNBOOK.md` | OperaciÃ³n y troubleshooting | `/docs/` |
| `TEST_RESULTS.md` | Evidencias de pruebas | `/docs/` |

### 8.2 Template de Resultados de Despliegue

```markdown
# Resultados de Despliegue - [FECHA]

## InformaciÃ³n del Ambiente
- **Resource Group:** rg-agents-prod
- **RegiÃ³n:** East US 2
- **Environment:** Azure Container Apps

## URLs de Acceso
| Servicio | URL | Estado |
|----------|-----|--------|
| Frontend | https://ca-frontend.xxx.azurecontainerapps.io | âœ… Operativo |
| Backend | https://ca-backend.internal.xxx | âœ… Operativo |

## Recursos Desplegados
- Container Apps Environment: cae-agents-prod
- Container App (Frontend): ca-frontend
- Container App (Backend): ca-backend
- Container Registry: acragentsprod
- Key Vault: kv-agents-prod
- Managed Identity: id-agents-prod

## Pruebas Ejecutadas
| Prueba | Resultado | Evidencia |
|--------|-----------|-----------|
| Health Check | âœ… PASS | [screenshot] |
| Conectividad FE-BE | âœ… PASS | [logs] |
| ConexiÃ³n DB | âœ… PASS | [query result] |
| Azure OpenAI | âœ… PASS | [response] |

## Observaciones y Recomendaciones
1. Implementar Azure Front Door para CDN y WAF
2. Configurar alertas en Azure Monitor
3. Habilitar Defender for Containers
4. Revisar polÃ­ticas de backup de PostgreSQL
```

---

## âš ï¸ Restricciones CrÃ­ticas

```markdown
ğŸš« PROHIBIDO:
- Eliminar o romper funcionalidades existentes
- Modificar comportamiento sin documentar y justificar
- Exponer secretos en cÃ³digo o logs
- Usar imÃ¡genes base sin escaneo de vulnerabilidades
- Desplegar sin health checks configurados
- Ignorar errores de conectividad en pruebas
```

---

## ğŸ“¦ Entregables Finales

| # | Entregable | Estado |
|---|------------|--------|
| 1 | AnÃ¡lisis tÃ©cnico completo (FE + BE) | â¬œ |
| 2 | Dockerfiles optimizados | â¬œ |
| 3 | docker-compose.yml funcional | â¬œ |
| 4 | Evidencia de ejecuciÃ³n local | â¬œ |
| 5 | Scripts de despliegue Azure | â¬œ |
| 6 | Evidencia de despliegue en Azure | â¬œ |
| 7 | Resultados de pruebas de conectividad | â¬œ |
| 8 | DocumentaciÃ³n tÃ©cnica integral | â¬œ |
| 9 | Lista priorizada de mejoras | â¬œ |
| 10 | CatÃ¡logo de variables de entorno | â¬œ |

---

## ğŸ”„ Flujo de Trabajo Sugerido

```
1. AnÃ¡lisis de CÃ³digo
       â†“
2. Inventario de Variables
       â†“
3. ContenerizaciÃ³n Local
       â†“
4. Pruebas Locales
       â†“
5. ConfiguraciÃ³n Key Vault
       â†“
6. Despliegue en Azure
       â†“
7. Pruebas de Conectividad
       â†“
8. Hardening de Seguridad
       â†“
9. DocumentaciÃ³n Final
```

---

*Prompt versiÃ³n 2.0 - Optimizado para revisiÃ³n tÃ©cnica full-stack y despliegue en Azure*
*Generado el: 22 de Enero de 2026*
